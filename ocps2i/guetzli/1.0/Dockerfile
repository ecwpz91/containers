FROM centos/s2i-base-centos7

ENV CONTAINER="docker" \
    LANG="en_US.UTF-8" \
		TERM="xterm" \
		HOME="/opt/app-root/src" \
		GUETZLI_MAJOR="1" \
		GUETZLI_MINOR="0" \
		GUETZLI_PATCH="1" \
		NAMESPACE="rh" \
		GUETZLI_SRC="https://github.com/google/guetzli/archive" \
		NSS_SRC="https://dl.fedoraproject.org/pub/epel/7/x86_64/n" \
		NSS_RPM="nss_wrapper-1.1.3-1.el7.x86_64.rpm"

ENV SUMMARY="A Open Source JPEG Encoder" \
		DESCRIPTION="Guetzli is a JPEG encoder that aims for excellent compression \
		density at high visual quality. Guetzli-generated images are typically 20-30% \
		smaller than images of equivalent quality generated by libjpeg. Guetzli \
		generates only sequential (nonprogressive) JPEGs due to faster decompression \
		speeds they offer." \
		GUETZLI_HOME="/opt/$NAMESPACE/guetzli-$GUETZLI_MINOR.$GUETZLI_PATCH" \
		GUETZLI_VERSION="$GUETZLI_MAJOR.$GUETZLI_MINOR" \
# Incantations to enable Software Collections on `bash` and `sh -i`
    ENABLED_COLLECTIONS="$NAMESPACE-guetzli$MONGODB_MAJOR$MONGODB_MINOR" \
		BASH_ENV="/opt/app-root/etc/scl_enable" \
		ENV="/opt/app-root/etc/scl_enable" \
		PROMPT_COMMAND=". /opt/app-root/etc/scl_enable" \
		GUETZLI_ARCHIVE="v$GUETZLI_MAJOR.$GUETZLI_MINOR.$GUETZLI_PATCH.tar.gz"

LABEL summary="$SUMMARY" \
		io.k8s.description="$DESCRIPTION" \
		io.k8s.display-name=" Guetzli $GUETZLI_VERSION" \
		io.openshift.expose-services="8080:tcp" \
		io.openshift.tags="guetzli" \
		com.redhat.component="$ENABLED_COLLECTIONS-docker" \
		name="centos/guetzli-$GUETZLI_MAJOR$GUETZLI_MINOR-centos7" \
		version="$GUETZLI_VERSION" \
		release="$GUETZLI_PATCH" \
		maintainer="SoftwareCollections.org <sclorg@redhat.com>"

RUN yum install -y centos-release-scl \
&& yum-config-manager --enable centos-sclo-rh-testing \
&& INSTALL_PKGS="libpng libstdc++ libgcc cmake gcc-c++ libpng-devel make" \
&& yum install -y --setopt=tsflags=nodocs $INSTALL_PKGS $NSS_SRC/$NSS_RPM --nogpgcheck \
&& rpm -V $INSTALL_PKGS \
# Install  Guetzli archive
&& mkdir -p $GUETZLI_HOME \
&& curl -L $GUETZLI_SRC/$GUETZLI_ARCHIVE \
| tar -xzf - -C $GUETZLI_HOME --strip 1 \
&& ( pushd $GUETZLI_HOME \
	   && make &>/dev/null \
		 && chmod +x $GUETZLI_HOME/bin/Release/* \
		 && ln -s $GUETZLI_HOME/bin/Release/* /usr/bin \
		 && popd ) \
&& yum remove -y gcc-c++ libpng-devel make \
&& yum -y clean all \
# Remove systemd boot targets - improves container init performance
&& (cd /lib/systemd/system/sysinit.target.wants \
&& for i in *; do [ $i = systemd-tmpfiles-setup.service ] || rm -vf $i; done) \
&& rm -rf /lib/systemd/system/multi-user.target.wants/*      \
          /etc/systemd/system/*.wants/*                      \
					/lib/systemd/system/local-fs.target.wants/*        \
					/lib/systemd/system/sockets.target.wants/*udev*    \
					/lib/systemd/system/sockets.target.wants/*initctl* \
					/lib/systemd/system/basic.target.wants/*           \
					/lib/systemd/system/anaconda.target.wants/*

# Copy the S2I scripts from the specific language image to $STI_SCRIPTS_PATH
COPY ./s2i/bin/ /usr/libexec/s2i/

# Copy extra files to the image.
COPY ./root/ /

RUN fix-permissions /opt/app-root/*
USER 1001

# Set the default CMD to print the usage of the language image
CMD ["/usr/libexec/s2i/usage"]
